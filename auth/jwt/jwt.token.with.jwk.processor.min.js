"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JwtTokenWithJWKProcessor=void 0;const common_1=require("@nestjs/common"),jose=require("jose"),jwt_token_processor_1=require("./jwt.token.processor");class JwtTokenWithJWKProcessor extends jwt_token_processor_1.JwtTokenProcessor{constructor(e,o){super(new common_1.Logger(JwtTokenWithJWKProcessor.name)),this.key=e,this.jwk=o}async validateToken(e){this.log.debug("Call validateToken");const[o,t]=this.parse(e);if("None"===o.alg)return t;if(!o.jwk)throw new Error("Unsupported token. JWK is not set");if(!o.jwk.kty)return t;const r=await jose.importJWK(o.jwk);if(await jose.jwtVerify(e,r))return t;throw new Error("Could not validate token")}async createToken(e){this.log.debug("Call createToken");const o=await jose.importPKCS8(this.key,"RS256");return new jose.SignJWT(e).setProtectedHeader({typ:"JWT",alg:"RS256",jwk:this.jwk}).sign(o)}}exports.JwtTokenWithJWKProcessor=JwtTokenWithJWKProcessor;