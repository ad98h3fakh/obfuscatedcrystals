"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JwtTokenWithSqlKIDProcessor=void 0;const common_1=require("@nestjs/common"),jwt_simple_1=require("jwt-simple"),jwt_token_processor_1=require("./jwt.token.processor");class JwtTokenWithSqlKIDProcessor extends jwt_token_processor_1.JwtTokenProcessor{constructor(e,o){super(new common_1.Logger(JwtTokenWithSqlKIDProcessor.name)),this.em=e,this.key=o}async validateToken(e){this.log.debug("Call validateToken");const[o,t]=this.parse(e),s=JwtTokenWithSqlKIDProcessor.KID_FETCH_QUERY(this.key,o.kid);this.log.debug(`Executing key fetching query: ${s}`);const r=await this.em.getConnection().execute(s);return this.log.debug(`Key is ${r.key}`),"None"===o.alg?t:jwt_simple_1.decode(e,this.key,!1,o.alg)}async createToken(e){this.log.debug("Call createToken");const o={alg:"HS256",kid:`${JwtTokenWithSqlKIDProcessor.KID}`,typ:"JWT"};return jwt_simple_1.encode(e,this.key,"HS256",{header:o})}}exports.JwtTokenWithSqlKIDProcessor=JwtTokenWithSqlKIDProcessor,JwtTokenWithSqlKIDProcessor.KID=0,JwtTokenWithSqlKIDProcessor.KID_FETCH_QUERY=(e,o)=>`select key from (select '${e}' as key, ${JwtTokenWithSqlKIDProcessor.KID} as id) as keys where keys.id = '${o}'`;