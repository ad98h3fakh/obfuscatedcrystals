"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JwtTokenWithJKUProcessor=void 0;const common_1=require("@nestjs/common"),jose=require("jose"),jwt_token_processor_1=require("./jwt.token.processor");class JwtTokenWithJKUProcessor extends jwt_token_processor_1.JwtTokenProcessor{constructor(e,t,o){super(new common_1.Logger(JwtTokenWithJKUProcessor.name)),this.key=e,this.httpClient=t,this.jkuUrl=o}async validateToken(e){this.log.debug("Call validateToken");const[t,o]=this.parse(e);if("None"===t.alg)return o;const s=t.jku;this.log.debug(`Calling jwk url: ${s}`);const r=await this.httpClient.loadJSON(s),n=await jose.importJWK(r);if(await jose.jwtVerify(e,n))return o;throw new Error("Could not validate")}async createToken(e){this.log.debug("Call createToken");const t=await jose.importPKCS8(this.key,"RS256");return new jose.SignJWT(e).setProtectedHeader({typ:"JWT",alg:"RS256",jku:this.jkuUrl}).sign(t)}}exports.JwtTokenWithJKUProcessor=JwtTokenWithJKUProcessor;