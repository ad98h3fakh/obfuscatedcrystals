"use strict";var AuthGuard_1,__decorate=this&&this.__decorate||function(e,t,r,a){var o,c=arguments.length,i=c<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var u=e.length-1;u>=0;u--)(o=e[u])&&(i=(c<3?o(i):c>3?o(t,r,i):o(t,r))||i);return c>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthGuard=void 0;const common_1=require("@nestjs/common"),core_1=require("@nestjs/core"),auth_service_1=require("./auth.service"),jwt_type_decorator_1=require("./jwt/jwt.type.decorator");let AuthGuard=AuthGuard_1=class{constructor(e,t){this.authService=e,this.reflector=t,this.logger=new common_1.Logger(AuthGuard_1.name)}async canActivate(e){try{this.logger.debug("Called canActivate");const t=e.switchToHttp().getRequest(),r=t.headers[AuthGuard_1.AUTH_HEADER];if(r&&0!=r.length){if(this.checkIsBearer(r))return!!await this.authService.validateToken(r.substring(7),auth_service_1.JwtProcessorType.BEARER);{const t=this.reflector.get(jwt_type_decorator_1.JwTypeMetadataField,e.getHandler());return!!await this.authService.validateToken(r,t)}}{const e=t.cookies[AuthGuard_1.AUTH_HEADER];if(e)return!!await this.authService.validateToken(e,auth_service_1.JwtProcessorType.BEARER);throw new common_1.UnauthorizedException}}catch(e){throw this.logger.debug(`Failed to validate token: ${e.message}`),new common_1.UnauthorizedException({error:"Unauthorized",line:__filename})}}checkIsBearer(e){if(!e||e.length<10)return!1;return"bearer "===e.substring(0,7).toLowerCase()}};AuthGuard.AUTH_HEADER="authorization",AuthGuard=AuthGuard_1=__decorate([common_1.Injectable(),__metadata("design:paramtypes",[auth_service_1.AuthService,core_1.Reflector])],AuthGuard),exports.AuthGuard=AuthGuard;