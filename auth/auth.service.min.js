"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var s,_=arguments.length,i=_<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(i=(_<3?s(i):_>3?s(t,o,i):s(t,o))||i);return _>3&&i&&Object.defineProperty(t,o,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthService=exports.JwtProcessorType=void 0;const core_1=require("@mikro-orm/core"),common_1=require("@nestjs/common"),config_1=require("@nestjs/config"),fs=require("fs"),keycloak_service_1=require("../keycloak/keycloak.service"),httpclient_service_1=require("../httpclient/httpclient.service"),auth_module_config_properties_1=require("./auth.module.config.properties"),jwt_token_bearer_processor_1=require("./jwt/jwt.token.bearer.processor"),jwt_token_with_jku_processor_1=require("./jwt/jwt.token.with.jku.processor"),jwt_token_with_jwk_processor_1=require("./jwt/jwt.token.with.jwk.processor"),jwt_token_with_rsa_keys_processor_1=require("./jwt/jwt.token.with.rsa.keys.processor"),jwt_token_with_sql_kid_processor_1=require("./jwt/jwt.token.with.sql.kid.processor"),jwt_token_with_weak_key_processor_1=require("./jwt/jwt.token.with.weak.key.processor"),jwt_token_with_x5c_key_processor_1=require("./jwt/jwt.token.with.x5c.key.processor"),jwt_token_with_x5u_key_processor_1=require("./jwt/jwt.token.with.x5u.key.processor");var JwtProcessorType;!function(e){e[e.RSA=0]="RSA",e[e.SQL_KID=1]="SQL_KID",e[e.WEAK_KEY=2]="WEAK_KEY",e[e.X5C=3]="X5C",e[e.X5U=4]="X5U",e[e.JKU=5]="JKU",e[e.JWK=6]="JWK",e[e.BEARER=7]="BEARER"}(JwtProcessorType=exports.JwtProcessorType||(exports.JwtProcessorType={}));let AuthService=class{constructor(e,t,o,r){this.configService=e,this.em=t,this.httpClient=o,this.keyCloakService=r;const s=fs.readFileSync(this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWT_PRIVATE_KEY_LOCATION),"utf8"),_=fs.readFileSync(this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWT_PUBLIC_KEY_LOCATION),"utf8"),i=fs.readFileSync(this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWK_PRIVATE_KEY_LOCATION),"utf8"),c=(fs.readFileSync(this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWK_PUBLIC_KEY_LOCATION),"utf8"),JSON.parse(fs.readFileSync(this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWK_PUBLIC_JSON),"utf8"))),n=this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JKU_URL),p=this.configService.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_X5U_URL),h=e.get(auth_module_config_properties_1.AuthModuleConfigProperties.ENV_JWT_SECRET_KEY);this.processors=new Map,this.processors.set(JwtProcessorType.RSA,new jwt_token_with_rsa_keys_processor_1.JwtTokenWithRSAKeysProcessor(_,s)),this.processors.set(JwtProcessorType.SQL_KID,new jwt_token_with_sql_kid_processor_1.JwtTokenWithSqlKIDProcessor(this.em,h)),this.processors.set(JwtProcessorType.WEAK_KEY,new jwt_token_with_weak_key_processor_1.JwtTokenWithWeakKeyProcessor(h)),this.processors.set(JwtProcessorType.JKU,new jwt_token_with_jku_processor_1.JwtTokenWithJKUProcessor(i,this.httpClient,n)),this.processors.set(JwtProcessorType.JWK,new jwt_token_with_jwk_processor_1.JwtTokenWithJWKProcessor(i,c)),this.processors.set(JwtProcessorType.X5C,new jwt_token_with_x5c_key_processor_1.JwtTokenWithX5CKeyProcessor(i)),this.processors.set(JwtProcessorType.X5U,new jwt_token_with_x5u_key_processor_1.JwtTokenWithX5UKeyProcessor(i,this.httpClient,p)),this.processors.set(JwtProcessorType.BEARER,new jwt_token_bearer_processor_1.JwtBearerTokenProcessor(h,this.keyCloakService))}validateToken(e,t){return this.processors.get(t).validateToken(e)}createToken(e,t){return this.processors.get(t).createToken(e)}};AuthService=__decorate([common_1.Injectable(),__metadata("design:paramtypes",[config_1.ConfigService,core_1.EntityManager,httpclient_service_1.HttpClientService,keycloak_service_1.KeyCloakService])],AuthService),exports.AuthService=AuthService;