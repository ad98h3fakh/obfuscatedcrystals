"use strict";var AppController_1,__decorate=this&&this.__decorate||function(e,r,t,o){var i,n=arguments.length,p=n<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)p=Reflect.decorate(e,r,t,o);else for(var _=e.length-1;_>=0;_--)(i=e[_])&&(p=(n<3?i(p):n>3?i(r,t,p):i(r,t))||p);return n>3&&p&&Object.defineProperty(r,t,p),p},__metadata=this&&this.__metadata||function(e,r){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,r)},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppController=void 0;const common_1=require("@nestjs/common"),config_1=require("@nestjs/config"),swagger_1=require("@nestjs/swagger"),child_process_1=require("child_process"),dotT=require("dot"),libxmljs_1=require("libxmljs"),app_config_api_1=require("./app.config.api"),app_module_config_properties_1=require("./app.module.config.properties"),orm_module_config_properties_1=require("./orm/orm.module.config.properties"),app_controller_swagger_desc_1=require("./app.controller.swagger.desc");let AppController=AppController_1=class{constructor(e){this.configService=e,this.logger=new common_1.Logger(AppController_1.name)}async renderTemplate(e){if("string"==typeof e||Buffer.isBuffer(e)){const r=e.toString().trim(),t=dotT.compile(r)();return this.logger.debug(`Rendered template: ${t}`),t}}async redirect(e){return{url:e}}async xml(e){const r=libxmljs_1.parseXml(e,{dtdload:!0,noent:!0,doctype:!0,dtdvalid:!0,errors:!0});return this.logger.debug(r),this.logger.debug(r.getDtd()),r.toString(!0)}async getTestOptions(){this.logger.debug("Test OPTIONS")}async launchCommand(e){return this.logger.debug(`launch ${e} command`),new Promise(((r,t)=>{try{const[o,...i]=e.split(" "),n=child_process_1.spawn(o,i);n.stdout.on("data",(e=>{this.logger.debug(`stdout: ${e}`),r(e.toString("ascii"))})),n.stderr.on("data",(e=>{this.logger.debug(`stderr: ${e}`),r(e.toString("ascii"))})),n.on("error",(e=>t(e.message))),n.on("close",(e=>this.logger.debug(`child process exited with code ${e}`)))}catch(e){t(e.message)}}))}getConfig(){this.logger.debug("Called getConfig");const e=this.configService.get(orm_module_config_properties_1.OrmModuleConfigProperties.ENV_DATABASE_SCHEMA),r=this.configService.get(orm_module_config_properties_1.OrmModuleConfigProperties.ENV_DATABASE_HOST),t=this.configService.get(orm_module_config_properties_1.OrmModuleConfigProperties.ENV_DATABASE_PORT),o=this.configService.get(orm_module_config_properties_1.OrmModuleConfigProperties.ENV_DATABASE_USER),i=this.configService.get(orm_module_config_properties_1.OrmModuleConfigProperties.ENV_DATABASE_PASSWORD);return{awsBucket:this.configService.get(app_module_config_properties_1.AppModuleConfigProperties.ENV_AWS_BUCKET),sql:`postgres://${o}:${i}@${r}:${t}/${e} `,googlemaps:this.configService.get(app_module_config_properties_1.AppModuleConfigProperties.ENV_GOOGLE_MAPS)}}};__decorate([common_1.Post("render"),swagger_1.ApiProduces("text/plain"),swagger_1.ApiConsumes("text/plain"),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_RENDER_REQUEST}),swagger_1.ApiBody({description:"Write your text here"}),swagger_1.ApiCreatedResponse({description:"Rendered result"}),__param(0,common_1.Body()),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",Promise)],AppController.prototype,"renderTemplate",null),__decorate([common_1.Get("goto"),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_REDIRECT_REQUEST}),swagger_1.ApiOkResponse({description:"Redirected"}),common_1.Redirect(),__param(0,common_1.Query("url")),__metadata("design:type",Function),__metadata("design:paramtypes",[String]),__metadata("design:returntype",Promise)],AppController.prototype,"redirect",null),__decorate([common_1.Post("metadata"),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_XML_METADATA}),swagger_1.ApiInternalServerErrorResponse({description:"Invalid data"}),swagger_1.ApiCreatedResponse({description:"XML passed successfully"}),common_1.Header("content-type","text/xml"),__param(0,common_1.Query("xml")),__metadata("design:type",Function),__metadata("design:paramtypes",[String]),__metadata("design:returntype",Promise)],AppController.prototype,"xml",null),__decorate([common_1.Options(),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_OPTIONS_REQUEST}),common_1.Header("allow","OPTIONS, GET, HEAD, POST"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],AppController.prototype,"getTestOptions",null),__decorate([common_1.Get("spawn"),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_LAUNCH_COMMAND}),swagger_1.ApiOkResponse({type:String}),swagger_1.ApiInternalServerErrorResponse({schema:{type:"object",properties:{location:{type:"string"}}}}),__param(0,common_1.Query("command")),__metadata("design:type",Function),__metadata("design:paramtypes",[String]),__metadata("design:returntype",Promise)],AppController.prototype,"launchCommand",null),__decorate([common_1.Get("/config"),swagger_1.ApiOperation({description:app_controller_swagger_desc_1.SWAGGER_DESC_CONFIG_SERVER}),swagger_1.ApiOkResponse({type:app_config_api_1.AppConfig,status:200}),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",app_config_api_1.AppConfig)],AppController.prototype,"getConfig",null),AppController=AppController_1=__decorate([common_1.Controller("/api"),swagger_1.ApiTags("App controller"),__metadata("design:paramtypes",[config_1.ConfigService])],AppController),exports.AppController=AppController;