"use strict";var HeadersConfiguratorInterceptor_1,__decorate=this&&this.__decorate||function(e,r,t,o){var n,a=arguments.length,s=a<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(a<3?n(s):a>3?n(r,t,s):n(r,t))||s);return a>3&&s&&Object.defineProperty(r,t,s),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HeadersConfiguratorInterceptor=void 0;const common_1=require("@nestjs/common"),operators_1=require("rxjs/operators");let HeadersConfiguratorInterceptor=HeadersConfiguratorInterceptor_1=class{constructor(){this.logger=new common_1.Logger(HeadersConfiguratorInterceptor_1.name)}intercept(e,r){const t=e.switchToHttp().getRequest(),o=t.headers.cookie?t.headers.cookie.split("; "):[];if(o&&o.length>0)try{const e=o.reverse().find((e=>e.startsWith(HeadersConfiguratorInterceptor_1.COUNTER_COOKIE_NAME)));if(this.logger.log(`Cookie header: ${e}`),e){const r=e.split("=");if(isNaN(+r[1]))throw new Error("Invalid counter value")}}catch(e){throw new common_1.InternalServerErrorException({error:e.message,location:__filename})}return r.handle().pipe(operators_1.tap((()=>{const r=e.switchToHttp().getResponse();r.setCookie("bc-calls-counter",Date.now().toString(),{secure:!1}),t.query[HeadersConfiguratorInterceptor_1.NO_SEC_HEADERS_QUERY_PARAM]||(r.header(HeadersConfiguratorInterceptor_1.XSS_PROTECTION_HEADER,"0"),r.header(HeadersConfiguratorInterceptor_1.STRICT_TRANSPORT_SECURITY_HEADER,"max-age=0"),r.header(HeadersConfiguratorInterceptor_1.CONTENT_TYPE_OPTIONS,"1"),r.header(HeadersConfiguratorInterceptor_1.CONTENT_SECURITY_POLICY,"default-src  * 'unsafe-inline' 'unsafe-eval'"))})))}};HeadersConfiguratorInterceptor.XSS_PROTECTION_HEADER="x-xss-protection",HeadersConfiguratorInterceptor.STRICT_TRANSPORT_SECURITY_HEADER="strict-transport-security",HeadersConfiguratorInterceptor.CONTENT_TYPE_OPTIONS="x-content-type-options",HeadersConfiguratorInterceptor.CONTENT_SECURITY_POLICY="content-security-policy",HeadersConfiguratorInterceptor.NO_SEC_HEADERS_QUERY_PARAM="no-sec-headers",HeadersConfiguratorInterceptor.COUNTER_COOKIE_NAME="bc-calls-counter",HeadersConfiguratorInterceptor=HeadersConfiguratorInterceptor_1=__decorate([common_1.Injectable()],HeadersConfiguratorInterceptor),exports.HeadersConfiguratorInterceptor=HeadersConfiguratorInterceptor;